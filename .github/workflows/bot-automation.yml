name: Dependabot auto-approve

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    name: Approve & squash (as me)
    runs-on: ubuntu-latest
    # Only run for real Dependabot PRs that are not drafts
    if: github.event.pull_request.user.login == 'dependabot[bot]' && github.event.pull_request.draft == false

    env:
      # Your personal token so actions happen as you
      GH_TOKEN: ${{ secrets.BOT_PAT }}
      PR_URL: ${{ github.event.pull_request.html_url }}

    steps:
      # No checkout of PR code — we keep this workflow “no-code-exec” for safety.

      - name: Assert GH_TOKEN present
        run: |
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "GH_TOKEN is EMPTY. Check repo secrets or permissions." >&2
            exit 1
          fi

      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          # This action only needs read on metadata; PAT is fine.
          github-token: ${{ env.GH_TOKEN }}

      - name: Check update type
        id: gate
        shell: bash
        run: |
          t="${{ steps.metadata.outputs.update-type }}"
          if [ "$t" = "security" ] || [ "$t" = "version-update:semver-minor" ] || [ "$t" = "version-update:semver-patch" ]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Exit if not allowed
        if: steps.gate.outputs.ok != 'true'
        run: echo "Skipping auto-merge for update type ${{ steps.metadata.outputs.update-type }}"

      - name: Approve (as PAT owner)
        if: steps.gate.outputs.ok == 'true'
        run: gh pr review --approve "$PR_URL" --body "Auto-approving eligible Dependabot update."

      - name: Enable auto-merge (squash)
        if: steps.gate.outputs.ok == 'true'
        run: gh pr merge --squash --auto --delete-branch "$PR_URL"
